<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.16.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JH-Toolkit: include/jh/concurrent/flat_pool.h File Reference</title>
<link rel="icon" href="Jindallae.svg" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="Oree.svg"/></td>
  <td id="projectalign">
   <div id="projectname">JH-Toolkit<span id="projectnumber">&#160;v1.4.0</span>
   </div>
   <div id="projectbrief">An engineering-oriented C++20 toolkit with duck-typed concepts, static design, async coroutines, and semantic containers — header-only, RTTI-free, and concurrency-friendly.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.16.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('flat__pool_8h.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">flat_pool.h File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Key-based, contiguous, GC-like interning pool for copyable or movable objects.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;compare&gt;</code><br />
<code>#include &lt;vector&gt;</code><br />
<code>#include &lt;shared_mutex&gt;</code><br />
<code>#include &lt;atomic&gt;</code><br />
<code>#include &lt;cstddef&gt;</code><br />
<code>#include &lt;cstdint&gt;</code><br />
<code>#include &lt;tuple&gt;</code><br />
<code>#include &lt;memory&gt;</code><br />
<code>#include &lt;mutex&gt;</code><br />
<code>#include &lt;algorithm&gt;</code><br />
<code>#include &lt;type_traits&gt;</code><br />
<code>#include &lt;stdexcept&gt;</code><br />
<code>#include &quot;<a class="el" href="">jh/typing/monostate.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="">jh/core/ordered_map.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="">jh/conceptual/hashable.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="">jh/synchronous/control_buf.h</a>&quot;</code><br />
</div>
<p><a href="">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-nested-classes" class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:jh_3A_3Aconc_3A_3Aextension_3A_3Avalue_5Ffactory_3C_20V_20_3E" id="r_jh_3A_3Aconc_3A_3Aextension_3A_3Avalue_5Ffactory_3C_20V_20_3E"><td class="memItemLeft">struct &#160;</td><td class="memItemRight"><a class="el" href="structjh_1_1conc_1_1extension_1_1value__factory.html">jh::conc::extension::value_factory&lt; V &gt;</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Default value construction policy for <a class="el" href="classjh_1_1conc_1_1flat__pool.html" title="Hash-ordered, contiguous resource interning pool.">flat_pool</a>.  <a href="structjh_1_1conc_1_1extension_1_1value__factory.html#details">More...</a><br /></td></tr>
<tr class="memitem:jh_3A_3Aconc_3A_3Aextension_3A_3Avalue_5Ffactory_3C_20std_3A_3Ashared_5Fptr_3C_20T_20_3E_20_3E" id="r_jh_3A_3Aconc_3A_3Aextension_3A_3Avalue_5Ffactory_3C_20std_3A_3Ashared_5Fptr_3C_20T_20_3E_20_3E"><td class="memItemLeft">struct &#160;</td><td class="memItemRight"><a class="el" href="structjh_1_1conc_1_1extension_1_1value__factory_3_01std_1_1shared__ptr_3_01T_01_4_01_4.html">jh::conc::extension::value_factory&lt; std::shared_ptr&lt; T &gt; &gt;</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Value construction policy specialization for <code>std::shared_ptr</code>.  <a href="structjh_1_1conc_1_1extension_1_1value__factory_3_01std_1_1shared__ptr_3_01T_01_4_01_4.html#details">More...</a><br /></td></tr>
<tr class="memitem:jh_3A_3Aconc_3A_3Aextension_3A_3Avalue_5Ffactory_3C_20std_3A_3Aunique_5Fptr_3C_20T_20_3E_20_3E" id="r_jh_3A_3Aconc_3A_3Aextension_3A_3Avalue_5Ffactory_3C_20std_3A_3Aunique_5Fptr_3C_20T_20_3E_20_3E"><td class="memItemLeft">struct &#160;</td><td class="memItemRight"><a class="el" href="structjh_1_1conc_1_1extension_1_1value__factory_3_01std_1_1unique__ptr_3_01T_01_4_01_4.html">jh::conc::extension::value_factory&lt; std::unique_ptr&lt; T &gt; &gt;</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Value construction policy specialization for <code>std::unique_ptr</code>.  <a href="structjh_1_1conc_1_1extension_1_1value__factory_3_01std_1_1unique__ptr_3_01T_01_4_01_4.html#details">More...</a><br /></td></tr>
<tr class="memitem:jh_3A_3Aconc_3A_3Aflat_5Fpool_3C_20Key_2C_20Value_2C_20Hash_2C_20Alloc_20_3E" id="r_jh_3A_3Aconc_3A_3Aflat_5Fpool_3C_20Key_2C_20Value_2C_20Hash_2C_20Alloc_20_3E"><td class="memItemLeft">class &#160;</td><td class="memItemRight"><a class="el" href="classjh_1_1conc_1_1flat__pool.html">jh::conc::flat_pool&lt; Key, Value, Hash, Alloc &gt;</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Hash-ordered, contiguous resource interning pool.  <a href="classjh_1_1conc_1_1flat__pool.html#details">More...</a><br /></td></tr>
<tr class="memitem:jh_3A_3Aconc_3A_3Aflat_5Fpool_3C_20Key_2C_20Value_2C_20Hash_2C_20Alloc_20_3E_3A_3Aptr" id="r_jh_3A_3Aconc_3A_3Aflat_5Fpool_3C_20Key_2C_20Value_2C_20Hash_2C_20Alloc_20_3E_3A_3Aptr"><td class="memItemLeft">struct &#160;</td><td class="memItemRight"><a class="el" href="structjh_1_1conc_1_1flat__pool_1_1ptr.html">jh::conc::flat_pool&lt; Key, Value, Hash, Alloc &gt;::ptr</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Reference-counted handle to a pooled object.  <a href="structjh_1_1conc_1_1flat__pool_1_1ptr.html#details">More...</a><br /></td></tr>
</table>
<a name="details" id="details"></a><h2 id="header-details" class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Key-based, contiguous, GC-like interning pool for copyable or movable objects. </p>
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright 2025 JeongHan-Bae &lt;mastropseudo@gmail.com&gt; <br  />
 Licensed under the Apache License, Version 2.0 (the "License"); <br  />
 you may not use this file except in compliance with the License.<br  />
 You may obtain a copy of the License at<br  />
 <br  />
 <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a><br  />
 <br  />
 Unless required by applicable law or agreed to in writing, software<br  />
 distributed under the License is distributed on an "AS IS" BASIS,<br  />
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.<br  />
 See the License for the specific language governing permissions and<br  />
 limitations under the License.<br  />
 <br  />
 Full license: <a href="https://github.com/JeongHan-Bae/JH-Toolkit?tab=Apache-2.0-1-ov-file#readme">GitHub</a></dd></dl>
<dl class="section author"><dt>Author</dt><dd>JeongHan-Bae <a href="#" onclick="location.href='mai'+'lto:'+'mas'+'tr'+'ops'+'eu'+'do@'+'gm'+'ail'+'.c'+'om'; return false;">&lt;mastropseudo@gmail.com&gt;</a></dd></dl>
<h3>Overview</h3>
<p><code><a class="el" href="classjh_1_1conc_1_1flat__pool.html" title="Hash-ordered, contiguous resource interning pool.">jh::conc::flat_pool</a></code> is a concurrent object interning container that deduplicates objects using an explicit external <b>key</b> and stores them inside a contiguous memory pool. Each unique key corresponds to at most one active slot at any time, and acquisitions return lightweight reference-counted handles (<code>flat_pool::ptr</code>) bound to stable indices. </p>
<p>Unlike pointer-based interning containers, <code>flat_pool</code> does <b>not</b> rely on <code>std::shared_ptr</code> for ownership, synchronization, or lifetime control. All concurrency guarantees are enforced exclusively through the pool's internal locking strategy. As a result, the behavior of the pool is independent of platform-specific <code>shared_ptr</code> implementations (including Windows-specific locking behavior). </p>
<h3>Key-Based Identity Model</h3>
<p>Object identity is defined entirely by an external <code>Key</code> type. The key must be: </p>
<ul>
<li>
lightweight to construct, </li>
<li>
cheap to hash and compare, </li>
<li>
capable of representing object identity independently of object storage. </li>
</ul>
<p>Lookup and deduplication are performed solely through the key. The stored object itself is never inspected for equality. This allows the pool to perform lookups <em>before</em> construction and avoids provisional object creation. </p>
<p>Keys are accepted in cv/ref-qualified form during acquisition. These equivalent key representations are used only for identification and are not retained unless insertion succeeds. </p>
<h3>Value Construction Model</h3>
<p>For map-like pools (<code>Value != <a class="el" href="structjh_1_1typed_1_1monostate.html" title="Trivial empty type representing &quot;no value&quot;.">jh::typed::monostate</a></code>), values are constructed using a <code>std::tuple</code> of arguments supplied at acquisition time. </p>
<ul>
<li>
The argument tuple is treated as <b>initialization-only</b> data. </li>
<li>
The argument tuple is not a complete data-tuple, but rather a left-value-tuple or perfectly-forwarded-tuple bound via <code>std::tie</code> or <code>std::forward_as_tuple</code>. </li>
<li>
If an equivalent key already exists, the tuple is discarded without constructing a value. </li>
<li>
Value construction occurs exactly once per unique key. </li>
</ul>
<p>Value creation is customizable via the public extension point <code><a class="el" href="structjh_1_1conc_1_1extension_1_1value__factory.html" title="Default value construction policy for flat_pool.">jh::conc::extension::value_factory&lt;Value&gt;</a></code>, enabling user-defined construction strategies without modifying or subclassing the pool. </p>
<h3>GC-like Lifetime Semantics</h3>
<p><code>flat_pool</code> deliberately adopts a <b>GC-like</b> lifetime model: </p>
<ul>
<li>
Reference counting represents <em>liveness</em>, not destruction. </li>
<li>
When a slot's reference count drops to zero, the slot becomes reusable. </li>
<li>
Objects are <b>not</b> destroyed immediately when they become unused. </li>
</ul>
<p>Instead of invoking destructors eagerly, the pool prefers slot reuse through assignment. This avoids repeated destructor / constructor cycles and significantly reduces allocation pressure for objects whose initialization may involve expensive memory allocation or resource setup. </p>
<p>Because destruction is deferred and non-deterministic, <code>flat_pool</code> is not suitable for objects whose correctness depends on immediate destruction when references are released. </p>
<p>In a manner of speaking, this design can be viewed as transforming <code>shared_ptr</code>, which performs allocation individually, into a bunch of smart pointers that allocate keys, values, index tables, and control blocks all in contiguous memory managed by the pool. </p>
<h3>Concurrency Model</h3>
<p>All synchronization is handled internally by the pool using shared and exclusive locks. No external atomic or smart-pointer-level synchronization is relied upon. </p>
<ul>
<li>
Lookup operations acquire shared locks only. </li>
<li>
Insertion, release, and resizing acquire exclusive locks. </li>
<li>
Reference counts are maintained using atomics. </li>
</ul>
<p>The pool stores objects in contiguous memory. To protect against vector reallocation during concurrent access, dereferencing a handle in multithreaded contexts requires holding a <code>no_reallocate_guard</code>. </p>
<h3>Comparison with <code>pointer_pool</code></h3>
<p><code>flat_pool</code> and <code>pointer_pool</code> address complementary problem domains: </p>
<ul>
<li>
<b><code>flat_pool</code></b>: <ul>
<li>
Key-driven identity </li>
<li>
Contiguous storage </li>
<li>
Slot reuse via assignment </li>
<li>
GC-like deferred destruction </li>
<li>
Entirely pool-controlled synchronization </li>
</ul>
</li>
<li>
<b><code>pointer_pool</code></b>: <ul>
<li>
Pointer-driven identity (Generally, comparisons of internal objects are proxied using <code><a class="el" href="structjh_1_1weak__ptr__hash.html" title="Content-based hash functor for std::weak_ptr&lt;T&gt;.">jh::weak_ptr_hash</a></code> and <code><a class="el" href="structjh_1_1weak__ptr__eq.html" title="Equality functor for std::weak_ptr&lt;T&gt;.">jh::weak_ptr_eq</a></code>.) <br  />
 On Windows, the native implementation of <code>shared_ptr</code> can cause greater jitter than POSIX.  </li>
<li>
Heap-allocated, immovable objects </li>
<li>
Immediate destruction via <code>shared_ptr</code> </li>
<li>
Weak-observed lifetime </li>
</ul>
</li>
</ul>
<p>If your objects: </p>
<ul>
<li>
are copyable or movable, </li>
<li>
can be identified by a lightweight external key, </li>
<li>
benefit from slot reuse and delayed destruction, </li>
</ul>
<p>then <code>flat_pool</code> is the preferred structure. </p>
<p>If your objects: </p>
<ul>
<li>
must reside at a stable address, </li>
<li>
cannot be copied or moved, </li>
<li>
or must release heavy resources exactly when the last reference disappears, </li>
</ul>
<p>then a pointer-based pool should be used instead. </p>
<dl class="section version"><dt>Version</dt><dd><pre>1.4.x</pre> </dd></dl>
<dl class="section date"><dt>Date</dt><dd><pre>2025</pre> </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
</div> <!-- top -->
<hr class="footer"/>
<div class="footer">
    <img class="footer-logo" src="Ojing.svg" alt="Ojing"/>
    <div class="footer-text">
        JH-Toolkit v1.4.0 · Generated by Doxygen
    </div>
    <div class="footer-note">
        We primarily support embedded documentation views in IDEs (classic CLion).
        To ensure compatibility with embedded rendering, some example code in this
        documentation intentionally contains HTML entities.
        In certain cases, Doxygen does not unescape these entities correctly.
        This is a known limitation and currently has no workaround.
    </div>
</div>
</body>
</html>

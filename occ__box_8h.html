<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.16.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JH-Toolkit: include/jh/concurrent/occ_box.h File Reference</title>
<link rel="icon" href="Jindallae.svg" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="Oree.svg"/></td>
  <td id="projectalign">
   <div id="projectname">JH-Toolkit<span id="projectnumber">&#160;v1.4.0</span>
   </div>
   <div id="projectbrief">An engineering-oriented C++20 toolkit with duck-typed concepts, static design, async coroutines, and semantic containers — header-only, RTTI-free, and concurrency-friendly.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.16.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('occ__box_8h.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">occ_box.h File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>A generic container abstraction based on <b>OCC (Optimistic Concurrency Control)</b>.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;jh/detail/shared_ptr_atomic_shim.h&quot;</code><br />
<code>#include &lt;memory&gt;</code><br />
<code>#include &lt;atomic&gt;</code><br />
<code>#include &lt;<a class="el" href="">concepts</a>&gt;</code><br />
<code>#include &lt;cstdint&gt;</code><br />
<code>#include &lt;functional&gt;</code><br />
<code>#include &lt;type_traits&gt;</code><br />
<code>#include &lt;optional&gt;</code><br />
</div>
<p><a href="">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-nested-classes" class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:jh_3A_3Aconc_3A_3Aocc_5Fbox_3C_20T_20_3E" id="r_jh_3A_3Aconc_3A_3Aocc_5Fbox_3C_20T_20_3E"><td class="memItemLeft">class &#160;</td><td class="memItemRight"><a class="el" href="classjh_1_1conc_1_1occ__box.html">jh::conc::occ_box&lt; T &gt;</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Generic container providing <b>Optimistic Concurrency Control (OCC)</b>.  <a href="classjh_1_1conc_1_1occ__box.html#details">More...</a><br /></td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-define-members" class="groupheader"><a id="define-members" name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a0cbd467477a260d55936dba192658b11" id="r_a0cbd467477a260d55936dba192658b11"><td class="memItemLeft"><a id="a0cbd467477a260d55936dba192658b11" name="a0cbd467477a260d55936dba192658b11"></a>
#define&#160;</td><td class="memItemRight"><b>JH_OCC_ENABLE_MULTI_COMMIT</b>&#160;&#160;&#160;1</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-func-members" class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:aa02474715e5cc5c411005fdf6ad06071" id="r_aa02474715e5cc5c411005fdf6ad06071"><td class="memTemplParams" colspan="2">template&lt;typename... Boxes, typename... Funcs&gt; </td></tr>
<tr class="memitem:aa02474715e5cc5c411005fdf6ad06071 template"><td class="memItemLeft">bool&#160;</td><td class="memItemRight"><a class="el" href="namespacejh_1_1conc.html#aa02474715e5cc5c411005fdf6ad06071">jh::conc::apply_to</a> (std::tuple&lt; Boxes &amp;... &gt; boxes, std::tuple&lt; Funcs... &gt; &amp;&amp;funcs)</td></tr>
<tr class="memdesc:aa02474715e5cc5c411005fdf6ad06071"><td class="mdescLeft">&#160;</td><td class="mdescRight">Apply functions to multiple <code><a class="el" href="classjh_1_1conc_1_1occ__box.html" title="Generic container providing Optimistic Concurrency Control (OCC).">occ_box</a></code>es atomically.  <br /></td></tr>
</table>
<a name="details" id="details"></a><h2 id="header-details" class="groupheader">Detailed Description</h2>
<div class="textblock"><p>A generic container abstraction based on <b>OCC (Optimistic Concurrency Control)</b>. </p>
<pre class="fragment">* Copyright 2025 JeongHan-Bae &lt;mastropseudo@gmail.com&gt;
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*     http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
* </pre><dl class="section author"><dt>Author</dt><dd>JeongHan-Bae <a href="#" onclick="location.href='mai'+'lto:'+'mas'+'tr'+'ops'+'eu'+'do@'+'gm'+'ail'+'.c'+'om'; return false;">&lt;mastropseudo@gmail.com&gt;</a> </dd></dl>
<h3>Concurrency control models</h3>
<ul>
<li>
<p class="startli"><b>LBCC (Lock-Based Concurrency Control)</b><br  />
 Built-in support in C++ (<code>std::mutex</code>, <code>std::shared_mutex</code>).<br  />
 Flexible, efficient, but requires careful lock ordering to avoid deadlocks.<br  />
 No wrapper provided in this library.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><b>MVCC (Multi-Version Concurrency Control)</b><br  />
 Used in databases for snapshot isolation.<br  />
 Requires version chains, garbage collection, and complex rules.<br  />
 Not suitable for lightweight, in-memory concurrency here.</p>
<p class="endli"></p>
</li>
<li>
<b>OCC (Optimistic Concurrency Control)</b><br  />
 Implemented here as <code>occ_box&lt;T&gt;</code>.<br  />
 Works for arbitrary copy/move-constructible types.<br  />
 Provides optimistic reads and atomic replacement writes. </li>
</ul>
<h3>Read cost model</h3>
<p>A single <code>read()</code> operation typically incurs: </p><ul>
<li>
Two atomic loads of <code>shared_ptr&lt;state&gt;</code> (before/after validation). </li>
<li>
Two pointer dereferences (state → data → object). </li>
<li>
One function invocation (the user lambda). </li>
<li>
By default (<code>JH_OCC_ENABLE_MULTI_COMMIT == 1</code>), one extra atomic load of <code>flag_</code> is performed during validation. </li>
</ul>
<p>Reads are wait-free, never block writes, and retries only if a concurrent commit changes the <code>state</code> pointer between the two loads.</p>
<h3>Write semantics</h3>
<ul>
<li>
<code>write()</code> always creates a fresh copy of the object, applies the user lambda, and commits with a single CAS. </li>
<li>
<code>write_ptr()</code> allows the caller to supply a new <code>shared_ptr&lt;T&gt;</code>, avoiding deep copy overhead for large or expensive-to-copy objects. </li>
<li>
Both guarantee atomic replacement: no reader ever observes a partially written object. </li>
</ul>
<h3>try_* methods and retries</h3>
<ul>
<li>
All <code>try_*()</code> methods perform the first attempt outside of the loop. </li>
<li>
This ensures that <code>retries == 1</code> executes exactly once with no loop overhead. </li>
<li>
<code>retries == 0</code> is equivalent to <code>1</code> (a single attempt). </li>
<li>
For <code>retries &gt; 1</code>, the loop covers the remaining <code>retries - 1</code> attempts. </li>
<li>
Implementations are intentionally not abstracted into a common helper: any such abstraction would either add an <code>std::optional</code> allocation or an extra <code>invoke</code> in the retry path, both undesirable in hot loops. </li>
<li>
Users may implement exponential backoff or jitter in retry lambdas to mitigate contention. See <code>examples/example_occ_box.cpp</code> for a full example. In short: the lambda can take a <code>duration&amp;</code>, sleep if nonzero, update it (0 → min → min×base ... capped at max), then run business logic. </li>
</ul>
<h3>Atomicity and contention</h3>
<ul>
<li>
<b>Strong atomicity</b>: each commit replaces the entire state (data + version) with a single CAS. </li>
<li>
Readers are always safe: they either succeed with a consistent snapshot or retry internally. </li>
<li>
Writers never expose intermediate states. </li>
<li>
High-frequency writes may increase retries, but safety is never compromised. </li>
<li>
When <code>JH_OCC_ENABLE_MULTI_COMMIT == 1</code> (default), contention is resolved by strict priority: <b>multi-write &gt; single-write &gt; read</b>. </li>
</ul>
<h4>Multi-commit policy</h4>
<ul>
<li>
If <code>JH_OCC_ENABLE_MULTI_COMMIT</code> is <b>1</b> (default): <ul>
<li>
<code>occ_box</code> supports <code>apply_to()</code> for atomic multi-box transactions. </li>
<li>
Each box carries an extra <code>flag_</code> (<code>atomic&lt;bool&gt;</code>) used as a transaction marker. </li>
<li>
<code>read()</code> incurs one additional atomic load to check <code>flag_</code>. </li>
<li>
Conflict resolution follows: multi-write &gt; single-write &gt; read. </li>
</ul>
</li>
<li>
If <code>JH_OCC_ENABLE_MULTI_COMMIT</code> is <b>0</b>: <ul>
<li>
<code>apply_to()</code> is disabled. </li>
<li>
<code>occ_box</code> does not contain <code>flag_</code>, reducing object size. </li>
<li>
Single-box OCC still works, with lighter <code>read()</code> cost. </li>
</ul>
</li>
</ul>
<h3>Design intent</h3>
<ul>
<li>
Correctness and composability over raw microsecond performance. </li>
<li>
Deadlock-free by design: readers never block writers, writers never block readers. </li>
<li>
Best suited for application-level concurrency where retries are acceptable. </li>
</ul>
<dl class="section version"><dt>Version</dt><dd><pre>1.4.x</pre> </dd></dl>
<dl class="section date"><dt>Date</dt><dd><pre>2025</pre> </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
</div> <!-- top -->
<hr class="footer"/>
<div class="footer">
    <img class="footer-logo" src="Ojing.svg" alt="Ojing"/>
    <div class="footer-text">
        JH-Toolkit v1.4.0 · Generated by Doxygen
    </div>
    <div class="footer-note">
        We primarily support embedded documentation views in IDEs (classic CLion).
        To ensure compatibility with embedded rendering, some example code in this
        documentation intentionally contains HTML entities.
        In certain cases, Doxygen does not unescape these entities correctly.
        This is a known limitation and currently has no workaround.
    </div>
</div>
</body>
</html>

# This workflow ONLY checks whether documentation files are missing.
# It does NOT verify whether documentation content is up-to-date.

name: docs_presence_check

on:
  push:
    branches:
      - main
      - '*-dev'
    paths:
      - 'include/jh/**'
      - 'docs/**'
      - '.github/workflows/docs_presence_check.yml'

  pull_request:
    branches:
      - main
      - '*-dev'
    paths:
      - 'include/jh/**'
      - 'docs/**'
      - '.github/workflows/docs_presence_check.yml'

  workflow_dispatch:

jobs:
  gate:
    runs-on: ubuntu-latest
    outputs:
      run: ${{ steps.decide.outputs.run }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - id: decide
        shell: bash
        run: |
          set -e

          # Manual trigger always runs
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BASE=HEAD^
          TARGET=HEAD

          # Workflow file change → must run
          if git diff --name-only "$BASE" "$TARGET" -- .github/workflows/docs_presence_check.yml | grep -q .; then
            echo "run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Any docs change (A / D / M) → must run
          if git diff --name-only "$BASE" "$TARGET" -- docs | grep -q .; then
            echo "run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # include/jh add or delete → must run
          if git diff --name-only --diff-filter=AD "$BASE" "$TARGET" -- include/jh | grep -q .; then
            echo "run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Otherwise: only implementation changes → skip
          echo "run=false" >> "$GITHUB_OUTPUT"

  docs-presence-check:
    needs: gate
    if: needs.gate.outputs.run == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check missing documentation
        shell: bash
        run: |
          set -euo pipefail

          # ===== Exclusion lists =====

          EXCLUDE_FILES=(
            "include/jh/macros/header_begin.h"
            "include/jh/macros/header_end.h"
          )

          EXCLUDE_DIRS=(
            "include/jh/detail/"
          )

          is_excluded() {
            local file="$1"

            for f in "${EXCLUDE_FILES[@]}"; do
              [ "$file" = "$f" ] && return 0
            done

            for d in "${EXCLUDE_DIRS[@]}"; do
              [[ "$file" == "$d"* ]] && return 0
            done

            return 1
          }

          echo "Checking for headers without documentation..."

          MISSING_HEADERS=()

          while IFS= read -r header; do
            if is_excluded "$header"; then
              continue
            fi

            doc="docs/${header#include/jh/}"
            doc="${doc%.h}.md"

            if [ ! -f "$doc" ]; then
              MISSING_HEADERS+=("$header")
            fi
          done < <(find include/jh -type f -name "*.h")

          SUMMARY="$GITHUB_STEP_SUMMARY"

          if [ "${#MISSING_HEADERS[@]}" -ne 0 ]; then
            {
              echo "## ⚠️ Missing Documentation Detected"
              echo
              echo "The following public headers do not have corresponding documentation files:"
              echo
              for h in "${MISSING_HEADERS[@]}"; do
                echo "- \`$h\`"
              done
              echo
              echo "> This check **does not** verify whether documentation is up-to-date."
              echo "> It only checks for **missing documentation files**."
            } >> "$SUMMARY"

            echo "::warning::Missing documentation detected (${#MISSING_HEADERS[@]} files)"
          else
            echo "## ✅ Documentation Presence OK" >> "$SUMMARY"
          fi

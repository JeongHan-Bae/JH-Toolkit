name: Cross-Platform CI

on:
  push:
    branches:
      - '*dev'
      - '**/*dev'
      - 'dev*'
      - '**/dev*'
    paths: &shared_paths
      - 'CMakeLists.txt'
      - 'src/**'
      - 'include/**'
      - 'examples/**'
      - 'tests/**'
      - '.github/workflows/ci.yml'

  pull_request:
    branches:
      - main
    paths: *shared_paths

  workflow_dispatch:

jobs:

  ubuntu-ci:
    name: Linux (Ubuntu / GCC)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Fast Install Dependencies (no man-db)
        run: |
          sudo apt-get update -qq
          sudo apt-get remove -y man-db || true
          echo "man-db hold" | sudo dpkg --set-selections
          sudo apt-get install -y --no-install-recommends eatmydata
          sudo eatmydata apt-get install -y --no-install-recommends ninja-build g++ cmake

      - name: Configure (FastDebug)
        run: cmake -B build-fastdebug -DCMAKE_BUILD_TYPE=FastDebug -G Ninja

      - name: Build
        run: cmake --build build-fastdebug -v

      - name: Run tests
        run: ctest --test-dir build-fastdebug --output-on-failure

  macos-ci:
    name: Darwin (macOS / LLVM @ 20)
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Dependencies (LLVM@20 + CMake + Ninja)
        run: |
          brew update -q
          for pkg in llvm@20 cmake ninja; do
            if ! brew list --versions "$pkg" >/dev/null; then
              brew install -q "$pkg"
            fi
          done
          brew link llvm@20 --force

      - name: Show compiler version
        run: |
          clang++ --version
          /opt/homebrew/opt/llvm@20/bin/clang++ --version

      - name: Configure (FastDebug with LLVM 20 + libc++)
        run: >
          cmake -B build-fastdebug
          -DCMAKE_BUILD_TYPE=FastDebug
          -G Ninja
          -DCMAKE_C_COMPILER=/opt/homebrew/opt/llvm@20/bin/clang
          -DCMAKE_CXX_COMPILER=/opt/homebrew/opt/llvm@20/bin/clang++
          -DCMAKE_CXX_FLAGS="-std=c++20 -stdlib=libc++"
          -DCMAKE_EXE_LINKER_FLAGS="-stdlib=libc++ -lc++abi"

      - name: Build
        run: cmake --build build-fastdebug -v

      - name: Run tests
        run: ctest --test-dir build-fastdebug --output-on-failure

  windows-ci:
    name: Windows (MSYS2 UCRT64 / MinGW-w64)
    runs-on: windows-latest
    timeout-minutes: 20
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Setup MSYS2 with GCC 13+
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-toolchain
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-ninja
          msystem: UCRT64

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure (Release, clean)
        run: |
          rm -rf build-release
          cmake -B build-release \
            -DCMAKE_BUILD_TYPE=Release \
            -G Ninja \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_CXX_COMPILER=g++

      - name: Build
        run: cmake --build build-release -v

      - name: Run tests
        run: ctest --test-dir build-release --output-on-failure
